<app-header [activePath]="'/checkout'" />
<app-ember-background density="sparse" [maxOpacity]="0.3" />

<main class="checkout-page">
  <div class="checkout-container">
    <h1 class="checkout-title">Narudžba</h1>

    <!-- Step indicator -->
    <div class="steps-bar">
      @for (step of steps; track step.key; let i = $index) {
        <div class="step" [class.active]="isStepActive(step.key)" [class.completed]="isStepCompleted(step.key)">
          <div class="step-number">
            @if (isStepCompleted(step.key)) {
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
              </svg>
            } @else {
              {{ i + 1 }}
            }
          </div>
          <span class="step-label">{{ step.label }}</span>
        </div>
        @if (i < steps.length - 1) {
          <div class="step-connector" [class.completed]="isStepCompleted(steps[i + 1].key)"></div>
        }
      }
    </div>

    @if (error()) {
      <div class="error-banner">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
        </svg>
        {{ error() }}
      </div>
    }

    <!-- Step 1: Review -->
    @if (currentStep() === 'review') {
      <div class="step-content">
        <h2 class="step-title">Pregled Korpe</h2>
        <div class="review-items">
          @for (item of cartService.items(); track item.productId) {
            <div class="review-item">
              <div class="review-item-image">
                @if (getImageUrl(item.productImageUrl)) {
                  <img [src]="getImageUrl(item.productImageUrl)" [alt]="item.productName" />
                } @else {
                  <div class="img-placeholder"></div>
                }
              </div>
              <div class="review-item-info">
                <span class="review-item-name">{{ item.productName }}</span>
                <span class="review-item-qty">Količina: {{ item.quantity }}</span>
              </div>
              <span class="review-item-price">{{ formatPrice(item.unitPrice * item.quantity) }} KM</span>
            </div>
          }
        </div>
        <div class="review-total">
          <span>Ukupno:</span>
          <span>{{ formatPrice(cartService.total()) }} KM</span>
        </div>
        <div class="step-actions">
          <a routerLink="/cart" class="btn-secondary">Nazad na Korpu</a>
          <button class="btn-primary" (click)="nextStep()">Nastavi</button>
        </div>
      </div>
    }

    <!-- Step 2: Address -->
    @if (currentStep() === 'address') {
      <div class="step-content">
        <h2 class="step-title">Adresa za Dostavu</h2>

        @if (isLoadingAddress()) {
          <div class="loading-state">Učitavanje adrese...</div>
        } @else if (isEditingAddress()) {
          <div class="address-form">
            <div class="form-group">
              <label for="street">Ulica i broj</label>
              <input id="street" type="text" [(ngModel)]="addressForm.street" placeholder="npr. Maršala Tita 1" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">Grad</label>
                <input id="city" type="text" [(ngModel)]="addressForm.city" placeholder="npr. Sarajevo" />
              </div>
              <div class="form-group">
                <label for="postalCode">Poštanski broj</label>
                <input id="postalCode" type="text" [(ngModel)]="addressForm.postalCode" placeholder="npr. 71000" />
              </div>
            </div>
            <div class="form-group">
              <label for="country">Država</label>
              <input id="country" type="text" [(ngModel)]="addressForm.country" />
            </div>
            <div class="form-actions">
              <button class="btn-secondary" (click)="cancelEditAddress()">Otkaži</button>
              <button class="btn-primary" (click)="saveAddress()" [disabled]="!addressForm.street || !addressForm.city || !addressForm.postalCode">Sačuvaj</button>
            </div>
          </div>
        } @else if (address()) {
          <div class="address-card">
            <div class="address-info">
              <p class="address-line">{{ address()!.street }}</p>
              <p class="address-line">{{ address()!.postalCode }} {{ address()!.city }}</p>
              <p class="address-line">{{ address()!.country }}</p>
            </div>
            <button class="btn-edit" (click)="startEditAddress()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
              </svg>
              Uredi
            </button>
          </div>
        } @else {
          <div class="no-address">
            <p>Nemate dodatu adresu za dostavu.</p>
            <button class="btn-primary" (click)="startEditAddress()">Dodaj Adresu</button>
          </div>
        }

        <div class="step-actions">
          <button class="btn-secondary" (click)="prevStep()">Nazad</button>
          <button class="btn-primary" (click)="nextStep()" [disabled]="!address()">Nastavi</button>
        </div>
      </div>
    }

    <!-- Step 3: Payment -->
    @if (currentStep() === 'payment') {
      <div class="step-content">
        <h2 class="step-title">Plaćanje Karticom</h2>

        @if (isLoadingStripe()) {
          <div class="loading-state">Učitavanje sistema za plaćanje...</div>
        } @else {
          <div class="stripe-payment">
            <div class="card-form">
              <div class="card-label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" />
                </svg>
                Podaci o kartici
              </div>
              <div id="card-element" class="card-element-container"></div>
              @if (cardError()) {
                <div class="card-error">{{ cardError() }}</div>
              }
            </div>

            <div class="order-summary-final">
              <div class="summary-line">
                <span>Proizvodi ({{ cartService.count() }})</span>
                <span>{{ formatPrice(cartService.total()) }} KM</span>
              </div>
              <div class="summary-line">
                <span>Dostava</span>
                <span class="free">Besplatna</span>
              </div>
              <div class="summary-divider"></div>
              <div class="summary-line total">
                <span>Ukupno za platiti</span>
                <span>{{ formatPrice(cartService.total()) }} KM</span>
              </div>
            </div>

            <div class="stripe-badge">
              <svg viewBox="0 0 60 25" xmlns="http://www.w3.org/2000/svg" width="60" height="25">
                <path fill="#8b4513" d="M59.64 14.28h-8.06c.19 1.93 1.6 2.55 3.2 2.55 1.64 0 2.96-.37 4.05-.95v3.32a12.3 12.3 0 01-4.56.88c-4.15 0-6.82-2.4-6.82-7.07 0-4.12 2.24-7.24 6.28-7.24 3.68 0 5.95 2.71 5.95 7.07 0 .54-.04 1.08-.04 1.44zm-4.18-5.2c0-.88-.39-2.06-1.68-2.06-1.24 0-1.8 1.18-1.92 2.06h3.6zM40.95 20.01V5.96h4.24l.26 1.58c.98-1.18 2.35-1.92 3.94-1.92.2 0 .4.02.58.06v4.48a5.7 5.7 0 00-.98-.08c-1.14 0-2.4.52-3.04 1.32v8.6h-5zm-6.3 0h5V.36h-5v19.65zM23.88 5.62c2.14 0 3.6.72 4.78 1.66l-1.92 2.9c-.88-.76-1.94-1.14-2.82-1.14-.72 0-1.22.34-1.22.82 0 .68 1.04.94 2.24 1.42 1.82.72 3.86 1.64 3.86 4.32 0 3.06-2.58 4.74-5.74 4.74-2.22 0-4.24-.82-5.56-2.14l2.18-2.82c1.04.98 2.42 1.54 3.46 1.54.82 0 1.36-.32 1.36-.86 0-.72-1-1.04-2.22-1.54-1.78-.7-3.76-1.64-3.76-4.28 0-2.92 2.32-4.62 5.36-4.62zM11.14 5.62c1.26 0 2.5.36 3.5 1.02V.36H9.58v11.58c0 2.88-.52 3.86-1.66 3.86-.74 0-1.54-.44-2.24-1.06l-2.12 3.32c1.18 1.22 2.82 2.28 5 2.28 3.64 0 5.58-2.72 5.58-7.78V5.62h-3z"/>
              </svg>
              <span>Sigurno plaćanje putem Stripe</span>
            </div>
          </div>
        }

        <div class="step-actions">
          <button class="btn-secondary" (click)="prevStep()">Nazad</button>
          <button class="btn-primary btn-order" (click)="confirmPayment()" [disabled]="isSubmitting() || !cardComplete() || isLoadingStripe()">
            @if (isSubmitting()) {
              Obrađujem plaćanje...
            } @else {
              Plati {{ formatPrice(cartService.total()) }} KM
            }
          </button>
        </div>
      </div>
    }

    <!-- Step 4: Confirmation -->
    @if (currentStep() === 'confirmation') {
      <div class="step-content confirmation">
        <div class="success-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
        </div>
        <h2 class="success-title">Narudžba Uspješna!</h2>
        <p class="success-message">Vaša narudžba #{{ orderId() }} je uspješno kreirana. Možete pratiti status u vašem računu.</p>
        <div class="confirmation-actions">
          <a routerLink="/account" class="btn-primary">Moje Narudžbe</a>
          <a routerLink="/shop" class="btn-secondary">Nastavi Kupovinu</a>
        </div>
      </div>
    }
  </div>
</main>
